# 액츄에이터

프로덕션 준비 기능이란?
프로젝트 설정
액츄에이터 시작
엔드포인트 설정
다양한 엔드포인트
헬스 정보
애플리케이션 정보
로거
HTTP 요청 응답 기록
액츄에이터와 보안
정리

# 프로덕션 준비 기능이란?

운영 환경에서 서비스할 때 필요한 이런 기능들을 프로덕션 준비 기능이라 한다.

* 지표(metric), 추적(trace), 감사(auditing)
* 모니터링

 애플리케이션이 현재 살아있는지, 로그 정보는 정상 설정 되었는지, 커넥션 풀은 얼마나 사용되고 있는지 등을 확인할 수 있어야 한다

액추에이터는  마이크로미터, 프로메테우스, 그라파나 같은 최근 유행하는 모니터링 시스템과 매우 쉽게 연동할 수 있는 기능도 제공한다

> 액추에이터는 시스템을 움직이거나 제어하는 데 쓰이는 기계 장치라는 뜻

# 프로젝트 설정

필요 의존성

```groovy
implementation 'org.springframework.boot:spring-boot-starter-actuator' // actuator 추가
```

# 액츄에이터 시작

http://localhost:8080/actuator 실행

```json
// http://localhost:8080/actuator

{
  "_links": {
    "self": {
      "href": "http://localhost:8080/actuator",
      "templated": false
    },
    "health": {
      "href": "http://localhost:8080/actuator/health",
      "templated": false
    },
    "health-path": {
      "href": "http://localhost:8080/actuator/health/{*path}",
      "templated": true
    }
  }
}
```

http://localhost:8080/actuator/health

```
// http://localhost:8080/actuator/health
{
  "status": "UP"
}
```

이 기능은 현재 서버가 잘 동작하고 있는지 애플리케이션의 헬스 상태를 나타낸다.

## 액츄에이터 기능을 웹에 노출

application.yml - 추가

```yml
management:
  endpoints:
    web:
      exposure:
        include: "*"
```

http://localhost:8080/actuator 실행하면 더 많은 정보가 나온다.

```json
// http://localhost:8080/actuator

{
  "_links": {
    "self": {
      "href": "http://localhost:8080/actuator",
      "templated": false
    },
    "beans": {
      "href": "http://localhost:8080/actuator/beans",
      "templated": false
    },
    "caches-cache": {
      "href": "http://localhost:8080/actuator/caches/{cache}",
      "templated": true
    },
    "caches": {
      "href": "http://localhost:8080/actuator/caches",
      "templated": false
    },
    "health-path": {
      "href": "http://localhost:8080/actuator/health/{*path}",
      "templated": true
    },
    "health": {
      "href": "http://localhost:8080/actuator/health",
      "templated": false
    },
 .....
```

액츄에이터가 제공하는 기능 하나하나를 **`엔드포인트라`** 한다. 

health 는 헬스 정보를, beans 는 스프링 컨테이너에 등록된 빈을 보여준다

각각의 엔드포인트는 /actuator/{엔드포인트명} 과 같은 형식으로 접근할 수 있다.

* http://localhost:8080/actuator/health : 애플리케이션 헬스 정보를 보여준다.
* http://localhost:8080/actuator/beans : 스프링 컨테이너에 등록된 빈을 보여준다.

# 엔드포인트 설정

엔드포인트를 사용하려면 다음 2가지 과정이 모두 필요하다.
1. 엔드포인트 활성화 - management.endpoint  - s가 붙지 않는다.
2. 엔드포인트 노출 - management.endpoints  -  s가 붙는다. 

엔드포인트를 활성화 한다는 것은 해당 기능 자체를 사용할지 말지 on , off 를 선택하는 것.

엔드포인트를 노출하는 것은 활성화된 엔드포인트를 HTTP에 노출할지 아니면 JMX에 노출할지 선택하는 것

엔드포인트를 활성화하고 추가로 HTTP를 통해서 웹에 노출할지, 아니면 JMX를 통해서 노출할지 두 위치에 모두 노출할지 노출 위치를 지정해주어야 한다.

**물론 활성화가 되어있지 않으면 노출도 되지 않는다.**

> HTTP와 JMX를 선택할 수 있는데, 보통 JMX 는 잘 사용하지 않으므로 HTTP에 어떤 엔드포인트를 노출할지 선택하면 된다

* JMX는 JDK 1.5부터 포함된 사양이라 한다. JMX는 실행 중인 애플리케이션의 상태를 모니터링 하고, 설정을 변경할 수 있게 해주는 API

## application.yml - 모든 엔드포인트를 웹에 노출

```yml
management:
  endpoints:
    web:
      exposure:
        include: "*"
```

* shutdown 엔드포인트는 기본으로 활성화 되지 않기 때문에 노출도 되지 않는다

**엔드포인트 활성화 + 엔드포인트 노출이 둘다 적용되어야 사용할 수 있다.**



## application.yml - shutdown 엔드포인트 활성화 - endpoint

```yml
management:
  endpoint:
    shutdown:
     enabled: true
   endpoints:
     web:
       exposure:
         include: "*"
```

특정 엔드포인트를 활성화 하려면 `management.endpoint.{엔드포인트명}.enabled=true` 를 적용하면 된다

* 웬만해선 키지 않는게 좋다.. 

## 엔드포인트 노출

스프링 공식 메뉴얼이 제공하는 예제를 통해서 엔드포인트 노출 설정

```yml
management:
  endpoints:
    jmx:
      exposure:
        include: "health,info"
    web:
      exposure:
        include: "*"
        exclude: "env,beans"
```

* jmx 에 health,info 를 노출한다
* web 에 모든 엔드포인트를 노출하지만 env , beans 는 제외한다

# 다양한 엔드포인트



# 헬스 정보



# 애플리케이션 정보



# 로거



# HTTP 요청 응답 기록



# 액츄에이터와 보안



# 정리