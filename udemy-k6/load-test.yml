name: ë¶€í•˜ í…ŒìŠ¤íŠ¸
run-name: 3. ${{ inputs.url }} ì„œë²„ ë™ì ‘ì ${{ inputs.vus }}ëª… ë¶€í•˜í…ŒìŠ¤íŠ¸ ğŸ’£ğŸ’£ğŸ’£
on:
  workflow_dispatch:
    inputs:
      url:
        description: 'ë¶€í•˜ í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê³ ì í•˜ëŠ” url'
        type: choice
        required: true
        options:
          - https://aicreation-develop2.miricanvas.com
      duration:
        description: 'í…ŒìŠ¤íŠ¸ ì§„í–‰í•  ì‹œê°„'
        type: number
        required: true
        default: 300
      vus:
        description: 'ë™ì ‘ì ìˆ˜'
        type: number
        required: true
        default: 10
      include-polling:
        description: 'í…ŒìŠ¤íŠ¸ì—ì„œ pollingì„ í¬í•¨í• ì§€ ì—¬ë¶€'
        type: boolean
        required: false
        default: false
      features:
        description: 'í…ŒìŠ¤íŠ¸ í•  ê¸°ëŠ¥ë“¤ì„ ì‰¼í‘œë¡œ êµ¬ë¶„í•´ì„œ ì…ë ¥ ex)text-to-image, image-to-image, remove-background, erase-area, outpaint, recolor, recommended-image, replace-background, upscale'
        type: string
        required: true
        default: 'text-to-image'
      same-auth:
        description: 'ë™ì¼í•œ ì¸ì¦ì •ë³´ë¥¼ ì‚¬ìš©í• ì§€ ì—¬ë¶€'
        type: boolean
        required: true
        default: false
      enable-external-api:
        description: 'ì™¸ë¶€ API ì‚¬ìš© ì—¬ë¶€'
        type: boolean
        required: true
        default: false

jobs:
  load-test:
    name: ë¶€í•˜ í…ŒìŠ¤íŠ¸
    runs-on: 4090-runner
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: ì‹œë‚˜ë¦¬ì˜¤ ì…ë ¥ê°’ ìœ íš¨ ê²€ì‚¬
        run: |
          VALID_FEATURES="text-to-image,image-to-image,remove-background,erase-area,outpaint,recolor,recommended-image,replace-background,upscale"
          
          # ê³µë°± ì œê±°
          features_cleaned=$(echo "${{ inputs.features }}" | tr -d '[:space:]')
          
          # ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ì…ë ¥ ê¸°ëŠ¥ì„ ë°°ì—´ë¡œ ë³€í™˜
          IFS=',' read -r -a input_features <<< "$features_cleaned"
          
          # ì…ë ¥ ê¸°ëŠ¥ì´ ìœ íš¨í•œì§€ í™•ì¸
          for feature in "${input_features[@]}"; do
            if [[ ! ",$VALID_FEATURES," =~ ",$feature," ]]; then
              echo "Invalid feature: $feature"
              exit 1
            fi
          done
      - name: k6 setup
        uses: grafana/setup-k6-action@v1

      - name: run k6 test
        uses: grafana/run-k6-action@v1
        with:
          path: module-infra/k6/script/script.js
          flags: '-o experimental-prometheus-rw'
        env:
          K6_PROMETHEUS_RW_SERVER_URL: http://cpdevk-metric.miricanvas.com:9009/api/v1/push
          K6_DURATION: ${{ inputs.duration }}s
          K6_VUS: ${{ inputs.vus }}
          K6_PROMETHEUS_RW_TREND_AS_NATIVE_HISTOGRAM: true
          K6_URL: ${{ inputs.url }}
          K6_REQUIRED_POLLING: ${{ inputs.include-polling }}
          K6_TEST: ${{ inputs.features }}
          K6_SAME_AUTH: ${{ inputs.same-auth }}
          K6_ENABLE_EXTERNAL_API: ${{ inputs.enable-external-api }}