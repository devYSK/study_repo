# CAP 이론과 Eventual Consistency



## CAP 이론



CAP은 분산 데이터베이스 시스템에서는 일관성(Consistency), 가용성(Availability), 파티션 허용성(Partition tolerance)을 모두 만족할 수 없다는 정리이다. 각각의 정의는 다음과 같다.



| 속성                                   | 설명                                                         |
| :------------------------------------- | :----------------------------------------------------------- |
| **일관성(Consistency)**                | 모든 요청은 최신 데이터 또는 에러를 응답받는다.              |
| **가용성(Availability)**               | 모든 요청은 정해진 시간 내에 정상 응답을 해야한다.           |
| **파티션 허용성(Partition tolerance)** | 네트워크가 단절된 상태에서도 시스템의 속성(정합성이나 가용성)을 유지해야한다는 속성. <br />분산환경에서는 네트워크상에 서버들이 분산배치되기 때문에 이 속성은 반드시 포함해야하는 속성이다. |

> 여기서 말하는 일관성은 [ACID](https://en.wikipedia.org/wiki/ACID)의 일관성과는 다르다. ACID의 일관성은 데이터베이스에서 트랜잭션이 완료되었을 때 기존의 제약(무결성 등)을 위반하지 않아야 함을 의미한다. 만약 트랜잭션이 제약을 위반한다면 그 트랜잭션은 실패해야한다

**CAP 이론은 CAP 속성을 정의한것으로 “적절한 응답 시간내에 세 가지 속성을 모두 만족시키는 분산 시스템을 구성할 수 없다”라고 정의한 이론이다.** 

 **‘일관성과 가용성은 상충 관계에 있지만 둘 중에 반드시 하나만을 선택해야 하는 것은 아니다’**

* 세 가지 속성 중 두 가지를 만족하는 시스템은 
  * CA(Consistency-Availability), 
  * CP(Consistency-Partition tolerance), 
  * AP(Availability-Partition tolerance) 세 종류로 나눌 수 있다. 

* CAP 이론은 네트워크 파티션 상황을 가정하므로 CA 시스템은 있을 수 없다. CA 시스템이 가능하려면 네트워크 파티션이 없어야 하는데 네트워크 파티션이 없으면 CAP 이론 자체가 쓸모 없을 뿐더러, 네트워크 파티션은 어떤 이유에서든 발생할 수 있다. 
* 





CAP는 분산시스템 설계에서 기술적인 선택을 돕는다. 

분산시스템이 모든 것 특성을 만족시킬 수 없음을 인지하게 하고 선택지를 제공해주는 것이다. 





관계형 데이터베이스는 정합성(C)과 가용성(A)에 초점이 맞춰져 있는 반면, 

NoSQL 솔루션들은 가용성(A) – 단절내성(P) 또는 정합성(C)-단절내성(P) 특성을 제공한다.

 CAP 이론에 따라 분산된 환경에서는 세 가지 속성을 동시에 만족시킬 수 없기 때문에 저장되는 데이터의 속성과 요구사항을 파악해 요구사항에 어떤 속성을 갖는지를 알아야 한다.

> noSQL 과 RDB 의 특징, 차이에 대해 알고 사용해야 한다. 

- Consistency(일관성): 데이터가 일관성이 있어야 한다. 모든 노드들은 동시에 같은 데이터를 보아야 한다
  - 여러 클라이언트는 동시에 같은 데이터를 봐야한다. 즉, 같은 시간에 조회하는 데이터는 항상 동일한 데이터여야한다
  - NoSQL은 eventual consistency
- Availability(가용성) : 모든 요청은 정해진 시간 내에 정상 응답을 해야한다.
  - replication : DB 서버가 장애가 발생하더라도 다른 서버에 있는 데이터를 가져와 계속 서비스 할 수 있다
    - 방법
      1. master slave
      2. peer to peer
  - MongoDB는 Replica Sets?
- Partition tolerance : 물리적인 네트워크 파티션을 넘어서도 잘 동작하여야 한다
  - 샤딩 : Scale out 수평적 확장을 해도 잘 동작해야 한다
  - 둘 이상의 DB 서버가 네트워크에 문제 생겨도 각 서버는 잘 동작해야한다

### RDBMS : CA에 집중

- C : 트랜잭션을 통한 ACID, 외래키
- A : Replication

### NoSQL : AP에 집중

- C : C는 eventual consistency를 선택하여, 최종적으로는 데이터가 동기화될 것이다
- A : Replica sets?
- P : Sharding

### Eventual Consistency(최종 일관성)

- **설명 : 당장은 맞지 않지만, (실시간 동기화는 불가능하지만) 결국 언젠가는 eventually 데이터가 동기화되어 일관성이 맞춰지는것을 말한다**

> 항목이 새롭게 업데이트되지 않는다는 전제하에 항목의 모든 읽기 작업이 최종적으로는 마지막으로 업데이트된 값을 반환한다는 것을 이론적으로 보장합니다. 
> 예 ) 인터넷 DNS(도메인 이름 시스템)는 eventual consistency 모델이 사용된 시스템

- NoSQL에서 분산 DB간의 Eventual Consistency 구현 방법

  1. 동기 : 데이터의 저장 결과를 클라이언트로 응답하기 전에 모든 노드에 데이터를 저장하는 동기식 방법

     - 느린 응답시간을 보이지만, 데이터의 정합성을 보장한다

  2. 비동기 : 메모리나 임시 파일에 기록하고 클라이언트에 먼저 응답한 다음, 특정 이벤트 또는 프로세스를 사용하여 노드로 데이터를 동기화하는 비동기식 방법

     - 빠른 응답시간을 보인다는 장점이 있지만, 쓰기 노드에 장애가 발생했을 경우 데이터가 손실 될 수 있다

     

### noSQL 과 RDB 의 특징, 차이에 대해 말씀해주세요. 어느 상황에 어떤 데이터베이스를 쓰는게 좋겠습니까?



# PACELC 이론

CAP 이론의 이러한 단점들을 보완하기 위해 나온 이론이 바로 [PACELC 이론](https://en.wikipedia.org/wiki/PACELC_theorem)이다. 

CAP 이론이 네트워크 파티션 상황에서 일관성-가용성 축을 이용하여 시스템의 특성을 설명한다면, PACELC 이론은 거기에 정상 상황이라는 새로운 축을 더한다. PACELC는 P(네트워크 파티션)상황에서 A(가용성)과 C(일관성)의 상충 관계와 E(else, 정상)상황에서 L(지연 시간)과 C(일관성)의 상충 관계를 설명한다







### 참조

* http://happinessoncode.com/2017/07/29/cap-theorem-and-pacelc-theorem/
* http://eincs.com/2013/07/misleading-and-truth-of-cap-theorem/